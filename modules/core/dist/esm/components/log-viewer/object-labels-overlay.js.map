{"version":3,"sources":["../../../../src/components/log-viewer/object-labels-overlay.js"],"names":["React","PureComponent","PropTypes","_MapContext","MapContext","PerspectivePopup","resolveCoordinateTransform","positionToLngLat","renderDefaultObjectLabel","id","isSelected","ObjectLabelsOverlay","props","object","objectSelection","frame","xvizStyleParser","style","renderObjectLabel","Boolean","styleProps","xvizStyles","labelContent","trackingPoint","objectHeight","streamNames","streamName","feature","getFeature","center","vertices","position","_getCoordinateProps","getStylesheet","getProperty","origin","state","coordinateProps","nextProps","setState","result","metadata","getTransformMatrix","streamMetadata","streams","viewport","Object","values","objects","map","_renderPerspectivePopup","func"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n// @flow\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {_MapContext as MapContext} from 'react-map-gl';\n\nimport PerspectivePopup from './perspective-popup';\n\nimport {resolveCoordinateTransform, positionToLngLat} from '../../utils/transform';\n\nconst renderDefaultObjectLabel = ({id, isSelected}) => isSelected && <div>ID: {id}</div>;\n\nexport default class ObjectLabelsOverlay extends PureComponent {\n  static propTypes = {\n    objectSelection: PropTypes.object,\n    frame: PropTypes.object,\n    metadata: PropTypes.object,\n    xvizStyleParser: PropTypes.object,\n\n    renderObjectLabel: PropTypes.func,\n    style: PropTypes.object,\n    getTransformMatrix: PropTypes.func\n  };\n\n  static defaultProps = {\n    objectSelection: {},\n    renderObjectLabel: renderDefaultObjectLabel,\n    style: {}\n  };\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      coordinateProps: {}\n    };\n  }\n\n  componentWillReceiveProps(nextProps) {\n    const {frame} = nextProps;\n\n    if (frame && frame !== this.props.frame) {\n      this.setState({\n        coordinateProps: {}\n      });\n    }\n  }\n\n  _getCoordinateProps(streamName) {\n    const {coordinateProps} = this.state;\n    let result = coordinateProps[streamName];\n\n    if (result) {\n      return result;\n    }\n\n    const {frame, metadata, getTransformMatrix} = this.props;\n    const streamMetadata = metadata.streams && metadata.streams[streamName];\n    result = resolveCoordinateTransform(frame, streamMetadata, getTransformMatrix);\n    // cache calculated coordinate props by stream name\n    coordinateProps[streamName] = result;\n\n    return result;\n  }\n\n  _renderPerspectivePopup = object => {\n    const {objectSelection, frame, xvizStyleParser, style, renderObjectLabel} = this.props;\n\n    const isSelected = Boolean(objectSelection[object.id]);\n    const styleProps = {\n      id: object.id,\n      isSelected,\n      object,\n      xvizStyles: xvizStyleParser\n    };\n\n    const labelContent = renderObjectLabel(styleProps);\n\n    if (!labelContent) {\n      return null;\n    }\n\n    let trackingPoint;\n    let objectHeight;\n\n    for (const streamName of object.streamNames) {\n      const feature = object.getFeature(streamName);\n      if (!trackingPoint && (feature.center || feature.vertices)) {\n        trackingPoint = positionToLngLat(object.position, this._getCoordinateProps(streamName));\n      }\n      if (!objectHeight && feature.vertices) {\n        objectHeight = xvizStyleParser.getStylesheet(streamName).getProperty('height', feature);\n      }\n    }\n\n    trackingPoint[2] += objectHeight || 0;\n\n    // compensate for camera offset\n    if (frame.origin) {\n      trackingPoint[2] -= frame.origin[2];\n    }\n\n    return (\n      <PerspectivePopup\n        key={object.id}\n        longitude={trackingPoint[0]}\n        latitude={trackingPoint[1]}\n        altitude={trackingPoint[2]}\n        anchor=\"bottom-left\"\n        dynamicPosition={true}\n        styleProps={styleProps}\n        style={style}\n        sortByDepth={true}\n        closeButton={false}\n        closeOnClick={false}\n      >\n        {labelContent}\n      </PerspectivePopup>\n    );\n  };\n\n  render() {\n    const {frame, viewport, renderObjectLabel} = this.props;\n\n    if (!frame || !renderObjectLabel) {\n      return null;\n    }\n\n    return (\n      <MapContext.Provider value={{viewport}}>\n        {Object.values(frame.objects).map(this._renderPerspectivePopup)}\n      </MapContext.Provider>\n    );\n  }\n}\n"],"file":"object-labels-overlay.js"}