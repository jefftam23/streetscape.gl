{"version":3,"sources":["../../../../src/components/log-viewer/core-3d-viewer.js"],"names":["React","PureComponent","PropTypes","StaticMap","DeckGL","COORDINATE_SYSTEM","ObjectLabelsOverlay","SimpleMeshLayer","XVIZStyleParser","XVIZLayer","VIEW_MODE","DEFAULT_VIEW_STATE","getViewStateOffset","getViews","getViewStates","resolveCoordinateTransform","mergeXVIZStyles","normalizeStreamFilter","stats","DEFAULT_ORIGIN","CAR_DATA","LIGHTS","DEFAULT_CAR","noop","getStreamMetadata","metadata","streamName","streams","Core3DViewer","constructor","props","deckMetrics","debug","metrics","fps","redraw","table","getTable","key","total","reset","viewState","oldViewState","viewOffset","onViewStateChange","info","evt","objectId","object","id","isHovering","Boolean","onHover","isRightClick","which","onContextMenu","onClick","state","styleParser","_getStyleParser","componentWillReceiveProps","nextProps","viewMode","initialViewState","x","y","bearing","xvizStyles","setState","frame","get","incrementCount","styles","_getCarLayer","car","origin","mesh","scale","wireframe","texture","color","opacity","coordinateSystem","METER_OFFSETS","coordinateOrigin","getTransformMatrix","d","vehicleRelativeTransform","clone","translate","data","getPosition","getColor","updateTriggers","_getLayers","showTooltip","objectStates","customLayers","lookAheads","streamFilter","featuresAndFutures","Set","Object","keys","concat","filter","Array","from","map","stream","streamMetadata","coordinateProps","stylesheet","getStylesheet","primitives","features","length","pickable","style","zIndex","type","pointCloud","sort","layer1","layer2","layer","additionalProps","assign","coordinate","_layerFilter","viewport","isPicking","_getViewState","trackedPosition","longitude","trackPosition","latitude","heading","offset","render","mapboxApiAccessToken","renderObjectLabel","mapStyle","showMap","_getCursor","_onLayerHover","_onLayerClick","_onViewStateChange","_onMetrics","firstPerson","selected","children","bool","string","oneOfType","array","func","PERSPECTIVE"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {StaticMap} from 'react-map-gl';\nimport DeckGL from '@deck.gl/react';\nimport {COORDINATE_SYSTEM} from '@deck.gl/core';\n\nimport ObjectLabelsOverlay from './object-labels-overlay';\n\nimport {SimpleMeshLayer} from '@deck.gl/mesh-layers';\nimport {XVIZStyleParser} from '@xviz/parser';\n\nimport XVIZLayer from '../../layers/xviz-layer';\n\nimport {VIEW_MODE, DEFAULT_VIEW_STATE} from '../../constants';\nimport {getViewStateOffset, getViews, getViewStates} from '../../utils/viewport';\nimport {resolveCoordinateTransform} from '../../utils/transform';\nimport {mergeXVIZStyles} from '../../utils/style';\nimport {normalizeStreamFilter} from '../../utils/stream-utils';\nimport stats from '../../utils/stats';\n\nimport {DEFAULT_ORIGIN, CAR_DATA, LIGHTS, DEFAULT_CAR} from './constants';\n\nconst noop = () => {};\n\nfunction getStreamMetadata(metadata, streamName) {\n  return (metadata && metadata.streams && metadata.streams[streamName]) || {};\n}\n\nexport default class Core3DViewer extends PureComponent {\n  static propTypes = {\n    // Props from loader\n    frame: PropTypes.object,\n    metadata: PropTypes.object,\n\n    // Rendering options\n    showMap: PropTypes.bool,\n    showTooltip: PropTypes.bool,\n    mapboxApiAccessToken: PropTypes.string,\n    mapStyle: PropTypes.oneOfType([PropTypes.object, PropTypes.string]),\n    xvizStyles: PropTypes.object,\n    car: PropTypes.object,\n    viewMode: PropTypes.object,\n    streamFilter: PropTypes.oneOfType([\n      PropTypes.string,\n      PropTypes.array,\n      PropTypes.object,\n      PropTypes.func\n    ]),\n    customLayers: PropTypes.array,\n    renderObjectLabel: PropTypes.func,\n    getTransformMatrix: PropTypes.func,\n\n    // Callbacks\n    onHover: PropTypes.func,\n    onClick: PropTypes.func,\n    onContextMenu: PropTypes.func,\n    onViewStateChange: PropTypes.func,\n\n    // Debug info listener\n    debug: PropTypes.func,\n\n    // States\n    viewState: PropTypes.object,\n    viewOffset: PropTypes.object,\n    objectStates: PropTypes.object\n  };\n\n  static defaultProps = {\n    car: DEFAULT_CAR,\n    viewMode: VIEW_MODE.PERSPECTIVE,\n    xvizStyles: {},\n    customLayers: [],\n    onViewStateChange: noop,\n    onHover: noop,\n    onClick: noop,\n    onContextMenu: noop,\n    showMap: true,\n    showTooltip: false\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      styleParser: this._getStyleParser(props)\n    };\n  }\n\n  componentWillReceiveProps(nextProps) {\n    if (this.props.viewMode !== nextProps.viewMode) {\n      const viewState = {\n        ...this.props.viewState,\n        ...DEFAULT_VIEW_STATE,\n        ...nextProps.viewMode.initialViewState\n      };\n      // Reset offset\n      const viewOffset = {\n        x: 0,\n        y: 0,\n        bearing: 0\n      };\n\n      nextProps.onViewStateChange({viewState, viewOffset});\n    }\n    if (\n      this.props.metadata !== nextProps.metadata ||\n      this.props.xvizStyles !== nextProps.xvizStyles\n    ) {\n      this.setState({\n        styleParser: this._getStyleParser(nextProps)\n      });\n    }\n    if (this.props.frame !== nextProps.frame) {\n      stats.get('frame-update').incrementCount();\n    }\n  }\n\n  _onMetrics = deckMetrics => {\n    if (this.props.debug) {\n      const metrics = {\n        fps: deckMetrics.fps,\n        redraw: deckMetrics.redraw || 0\n      };\n      const table = stats.getTable();\n\n      for (const key in table) {\n        metrics[key] = table[key].total;\n      }\n      this.props.debug(metrics);\n    }\n    stats.reset();\n  };\n\n  _onViewStateChange = ({viewState, oldViewState}) => {\n    const viewOffset = getViewStateOffset(oldViewState, viewState, this.props.viewOffset);\n    this.props.onViewStateChange({viewState, viewOffset});\n  };\n\n  _onLayerHover = (info, evt) => {\n    const objectId = info && info.object && info.object.id;\n    this.isHovering = Boolean(objectId);\n    this.props.onHover(info, evt);\n  };\n\n  _onLayerClick = (info, evt) => {\n    const isRightClick = evt.which === 3;\n\n    if (isRightClick) {\n      this.props.onContextMenu(info, evt);\n    } else {\n      this.props.onClick(info, evt);\n    }\n  };\n\n  _getStyleParser({metadata, xvizStyles}) {\n    return new XVIZStyleParser(mergeXVIZStyles(metadata && metadata.styles, xvizStyles));\n  }\n\n  _getCarLayer() {\n    const {frame, car} = this.props;\n    const {\n      origin = DEFAULT_ORIGIN,\n      mesh,\n      scale = [1, 1, 1],\n      wireframe = false,\n      texture = null,\n      color = [0, 0, 0]\n    } = car;\n\n    return new SimpleMeshLayer({\n      id: 'car',\n      opacity: 1,\n      coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS,\n      coordinateOrigin: frame.origin || DEFAULT_ORIGIN,\n      // Adjust for car center position relative to GPS/IMU\n      getTransformMatrix: d =>\n        frame.vehicleRelativeTransform\n          .clone()\n          .translate(origin)\n          .scale(scale),\n      mesh,\n      data: CAR_DATA,\n      getPosition: d => d,\n      getColor: color,\n      texture,\n      wireframe,\n      updateTriggers: {\n        getTransformMatrix: frame.vehicleRelativeTransform\n      }\n    });\n  }\n\n  _getLayers() {\n    const {\n      frame,\n      metadata,\n      showTooltip,\n      objectStates,\n      customLayers,\n      getTransformMatrix\n    } = this.props;\n    if (!frame || !metadata) {\n      return [];\n    }\n\n    const {streams, lookAheads = {}} = frame;\n    const {styleParser} = this.state;\n\n    const streamFilter = normalizeStreamFilter(this.props.streamFilter);\n    const featuresAndFutures = new Set(\n      Object.keys(streams)\n        .concat(Object.keys(lookAheads))\n        .filter(streamFilter)\n    );\n\n    return [\n      this._getCarLayer(),\n      Array.from(featuresAndFutures)\n        .map(streamName => {\n          // Check lookAheads first because it will contain the selected futures\n          // while streams would contain the full futures array\n          const stream = lookAheads[streamName] || streams[streamName];\n          const streamMetadata = getStreamMetadata(metadata, streamName);\n          const coordinateProps = resolveCoordinateTransform(\n            frame,\n            streamMetadata,\n            getTransformMatrix\n          );\n\n          const stylesheet = styleParser.getStylesheet(streamName);\n\n          // Support both features and lookAheads, respectively\n          const primitives = stream.features || stream;\n          if (primitives && primitives.length) {\n            return new XVIZLayer({\n              id: `xviz-${streamName}`,\n              ...coordinateProps,\n\n              pickable: showTooltip || primitives[0].id,\n\n              data: primitives,\n              style: stylesheet,\n              objectStates,\n\n              // Hack: draw extruded polygons last to defeat depth test when rendering translucent objects\n              // This is not used by deck.gl, only used in this function to sort the layers\n              zIndex: primitives[0].type === 'polygon' ? 2 : 0,\n\n              // Selection props (app defined, not used by deck.gl)\n              streamName\n            });\n          }\n          if (stream.pointCloud) {\n            return new XVIZLayer({\n              id: `xviz-${streamName}`,\n              ...coordinateProps,\n\n              pickable: showTooltip,\n\n              data: stream.pointCloud,\n              style: stylesheet,\n              vehicleRelativeTransform: frame.vehicleRelativeTransform,\n\n              // Hack: draw point clouds before polygons to defeat depth test when rendering translucent objects\n              // This is not used by deck.gl, only used in this function to sort the layers\n              zIndex: 1,\n\n              streamName\n            });\n          }\n          return null;\n        })\n        .filter(Boolean)\n        .sort((layer1, layer2) => layer1.props.zIndex - layer2.props.zIndex),\n      customLayers.map(layer => {\n        // Clone layer props\n        const {props} = layer;\n        const additionalProps = {};\n\n        if (props.streamName) {\n          // Use log data\n          const stream = streams[props.streamName];\n          const streamMetadata = getStreamMetadata(metadata, props.streamName);\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(frame, streamMetadata, getTransformMatrix),\n            {\n              data: stream && stream.features\n            }\n          );\n        } else if (props.coordinate) {\n          // Apply log-specific coordinate props\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(frame, props, getTransformMatrix)\n          );\n        } else {\n          return layer;\n        }\n\n        return layer.clone(additionalProps);\n      })\n    ];\n  }\n\n  _layerFilter({layer, viewport, isPicking}) {\n    if (viewport.id === 'driver') {\n      return layer.id !== 'car';\n    }\n    return true;\n  }\n\n  _getCursor = () => {\n    return this.isHovering ? 'pointer' : 'crosshair';\n  };\n\n  _getViewState() {\n    const {viewMode, frame, viewState, viewOffset} = this.props;\n\n    const trackedPosition = frame\n      ? {\n          longitude: frame.trackPosition[0],\n          latitude: frame.trackPosition[1],\n          bearing: 90 - frame.heading\n        }\n      : null;\n\n    return getViewStates({viewState, viewMode, trackedPosition, offset: viewOffset});\n  }\n\n  render() {\n    const {\n      mapboxApiAccessToken,\n      frame,\n      metadata,\n      objectStates,\n      renderObjectLabel,\n      getTransformMatrix,\n      style,\n      mapStyle,\n      viewMode,\n      showMap\n    } = this.props;\n    const {styleParser} = this.state;\n\n    return (\n      <DeckGL\n        width=\"100%\"\n        height=\"100%\"\n        effects={[LIGHTS]}\n        views={getViews(viewMode)}\n        viewState={this._getViewState()}\n        layers={this._getLayers()}\n        layerFilter={this._layerFilter}\n        getCursor={this._getCursor}\n        onHover={this._onLayerHover}\n        onClick={this._onLayerClick}\n        onViewStateChange={this._onViewStateChange}\n        _onMetrics={this._onMetrics}\n      >\n        {showMap && (\n          <StaticMap\n            reuseMap={true}\n            attributionControl={false}\n            mapboxApiAccessToken={mapboxApiAccessToken}\n            mapStyle={mapStyle}\n            visible={frame && frame.origin && !viewMode.firstPerson}\n          />\n        )}\n\n        <ObjectLabelsOverlay\n          objectSelection={objectStates.selected}\n          frame={frame}\n          metadata={metadata}\n          renderObjectLabel={renderObjectLabel}\n          xvizStyleParser={styleParser}\n          style={style}\n          getTransformMatrix={getTransformMatrix}\n        />\n\n        {this.props.children}\n      </DeckGL>\n    );\n  }\n}\n"],"file":"core-3d-viewer.js"}