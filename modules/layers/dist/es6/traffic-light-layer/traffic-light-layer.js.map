{"version":3,"sources":["../../../src/traffic-light-layer/traffic-light-layer.js"],"names":["Layer","CubeGeometry","SphereGeometry","Model","PhongMaterial","fp64","fp64LowPart","GL","vs","fs","makeLightShapeTexture","LIGHT_COLOR","invalid","green","yellow","red","LIGHT_SHAPE","circular","left_arrow","right_arrow","defaultProps","getPosition","type","value","x","position","getAngle","getShape","getColor","getState","sizeScale","min","material","shininess","specularColor","TrafficLightLayer","getShaders","projectModule","use64bitProjection","modules","initializeState","gl","context","modelsByName","_getModels","setState","models","box","lights","attributeManager","getAttributeManager","addInstanced","instancePositions","size","accessor","instancePositions64xyLow","update","calculateInstancePositions64xyLow","instanceAngles","instanceShapes","UNSIGNED_BYTE","calculateInstanceShapes","instanceColors","calculateInstanceColors","instanceStates","draw","uniforms","props","state","setUniforms","Object","assign","modelScale","shaders","id","shaderCache","geometry","isInstanced","modelTranslate","useInstanceColor","lightShapeTexture","updateAttributes","changedAttributes","getChangedAttributes","clearChangedFlags","model","getModels","setInstanceCount","data","length","setAttributes","attribute","isFP64","use64bitPositions","constant","Float32Array","i","point","color","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer} from '@deck.gl/core';\nimport {CubeGeometry, SphereGeometry, Model, PhongMaterial, fp64} from '@luma.gl/core';\nconst {fp64LowPart} = fp64;\nimport GL from '@luma.gl/constants';\n\nimport vs from './traffic-light-layer-vertex.glsl';\nimport fs from './traffic-light-layer-fragment.glsl';\n\nimport {makeLightShapeTexture} from './traffic-light-utils';\n\nconst LIGHT_COLOR = {\n  invalid: [0, 0, 0],\n  green: [0, 255, 128],\n  yellow: [255, 250, 0],\n  red: [255, 16, 16]\n};\n\n/* eslint-disable camelcase */\nconst LIGHT_SHAPE = {\n  circular: 0,\n  left_arrow: 1,\n  right_arrow: 2\n};\n/* eslint-enable camelcase */\n\nconst defaultProps = {\n  getPosition: {type: 'accessor', value: x => x.position},\n  getAngle: {type: 'accessor', value: 0},\n  getShape: {type: 'accessor', value: x => 'circular'},\n  getColor: {type: 'accessor', value: x => 'green'},\n  getState: {type: 'accessor', value: 1},\n\n  sizeScale: {type: 'number', value: 0.15, min: 0},\n\n  fp64: false,\n  material: new PhongMaterial({\n    shininess: 0,\n    specularColor: [0, 0, 0]\n  })\n};\n\nexport default class TrafficLightLayer extends Layer {\n  getShaders() {\n    const projectModule = this.use64bitProjection() ? 'project64' : 'project32';\n    return {vs, fs, modules: [projectModule, 'gouraud-lighting', 'picking']};\n  }\n\n  initializeState() {\n    const {gl} = this.context;\n    const modelsByName = this._getModels(gl);\n    this.setState({\n      models: [modelsByName.box, modelsByName.lights],\n      modelsByName\n    });\n\n    const attributeManager = this.getAttributeManager();\n    /* eslint-disable max-len */\n    attributeManager.addInstanced({\n      instancePositions: {\n        size: 3,\n        accessor: 'getPosition'\n      },\n      instancePositions64xyLow: {\n        size: 2,\n        accessor: 'getPosition',\n        update: this.calculateInstancePositions64xyLow\n      },\n      instanceAngles: {size: 1, accessor: 'getAngle'},\n      instanceShapes: {\n        size: 1,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getShape',\n        update: this.calculateInstanceShapes\n      },\n      instanceColors: {\n        size: 3,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getColor',\n        update: this.calculateInstanceColors\n      },\n      instanceStates: {\n        size: 1,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getState'\n      }\n    });\n    /* eslint-enable max-len */\n  }\n\n  draw({uniforms}) {\n    const {sizeScale} = this.props;\n    const {modelsByName} = this.state;\n\n    modelsByName.box\n      .setUniforms(\n        Object.assign({}, uniforms, {\n          modelScale: [sizeScale * 0.8, sizeScale * 1.6, sizeScale * 1.6]\n        })\n      )\n      .draw();\n    modelsByName.lights\n      .setUniforms(\n        Object.assign({}, uniforms, {\n          modelScale: [sizeScale, sizeScale, sizeScale]\n        })\n      )\n      .draw();\n  }\n\n  _getModels(gl) {\n    const shaders = this.getShaders();\n\n    const box = new Model(gl, {\n      id: `${this.props.id}-box`,\n      ...shaders,\n      shaderCache: this.context.shaderCache,\n      geometry: new CubeGeometry(),\n      isInstanced: true,\n      uniforms: {\n        modelTranslate: [0, 0, 0],\n        useInstanceColor: false\n      }\n    });\n\n    const lights = new Model(gl, {\n      id: `${this.props.id}-light`,\n      ...shaders,\n      shaderCache: this.context.shaderCache,\n      geometry: new SphereGeometry(),\n      isInstanced: true,\n      uniforms: {\n        lightShapeTexture: makeLightShapeTexture(gl),\n        modelTranslate: [-0.4, 0, 0],\n        useInstanceColor: true\n      }\n    });\n\n    return {box, lights};\n  }\n\n  updateAttributes(props) {\n    super.updateAttributes(props);\n    const attributeManager = this.getAttributeManager();\n    const changedAttributes = attributeManager.getChangedAttributes({clearChangedFlags: true});\n\n    for (const model of this.getModels()) {\n      model.setInstanceCount(this.props.data.length);\n      model.setAttributes(changedAttributes);\n    }\n  }\n\n  calculateInstancePositions64xyLow(attribute) {\n    const isFP64 = this.use64bitPositions();\n    attribute.constant = !isFP64;\n\n    if (!isFP64) {\n      attribute.value = new Float32Array(2);\n      return;\n    }\n\n    const {data, getPosition} = this.props;\n    const {value} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const position = getPosition(point);\n      value[i++] = fp64LowPart(position[0]);\n      value[i++] = fp64LowPart(position[1]);\n    }\n  }\n\n  calculateInstanceColors(attribute) {\n    const {data, getColor} = this.props;\n    const {value} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const color = LIGHT_COLOR[getColor(point)] || LIGHT_COLOR.invalid;\n      value[i++] = color[0];\n      value[i++] = color[1];\n      value[i++] = color[2];\n    }\n  }\n\n  calculateInstanceShapes(attribute) {\n    const {data, getShape} = this.props;\n    const {value} = attribute;\n    let i = 0;\n    for (const point of data) {\n      value[i++] = LIGHT_SHAPE[getShape(point)] || 0;\n    }\n  }\n}\n\nTrafficLightLayer.layerName = 'TrafficLightLayer';\nTrafficLightLayer.defaultProps = defaultProps;\n"],"file":"traffic-light-layer.js"}